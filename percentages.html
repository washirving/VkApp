<html>
<head>
<link href="style.css" type="text/css" rel="stylesheet"></link>
<meta charset="UTF-8">

<script src="https://vkontakte.ru/js/api/xd_connection.js?2" type="text/javascript"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
<script>
$(document).ready(function() {
	var current = 0;
    var xmlhttp = new XMLHttpRequest();
	xmlhttp.open("GET", "percentages.xml", false);
	xmlhttp.send();
	var xmlDoc = xmlhttp.responseXML; 
	var problems = xmlDoc.getElementsByTagName("problem");
	var answers = new Array(problems.length);
	var correctAnswers = new Array(problems.length);
	var result = "";
	
	$("#title").html(xmlDoc.getElementsByTagName("title")[0].childNodes[0].nodeValue);
	$("#text").html(problems[0].getElementsByTagName("text")[0].childNodes[0].nodeValue);
	for (var i = 0; i < problems.length; i++) {
		correctAnswers[i] = problems[i].getElementsByTagName("answer")[0].childNodes[0].nodeValue;
	}
	
	VK.init(function() {
		VK.api('storage.get', {key: 'math_kangaroo'}, function(r) { 
			if (r.response) {
				result = r.response.split("|")[0];
				answers = r.response.split("|")[1].split(",");
			}
			var distractorsData = problems[current].getElementsByTagName("distractor");
			var distractorsHTML = "";
			for (var j = 0; j < distractorsData.length; j++) {
				distractorsHTML += "<div class=\"distractor\">";
				distractorsHTML += "<input id=\"distractor" + j + "\" type=\"radio\"  name=\"distractors\" value=\"" + j + "\"";
				if (result !== "") {
					distractorsHTML += " disabled";
				}
				if (answers[current] == j) {
					distractorsHTML += " checked>";
				} else {
					distractorsHTML += ">";
				}
				distractorsHTML  += "<label for=\"distractor" + j + "\"";
				if (result !== "") {
					if ((correctAnswers[current] == answers[current]) && (answers[current] == j)) {
						distractorsHTML +=  "class=\"correct\"";
					} else if (answers[current] == j) {
						distractorsHTML += " class=\"incorrect\"";
					}
				}
				distractorsHTML += ">" + distractorsData[j].childNodes[0].nodeValue  + "</label>";
				distractorsHTML += "</div>";
			}
			$("#distractors").html(distractorsHTML);
		});
	});
		
			
	$("#next").click(function() {
		answers[current] = $("input[name='distractors']:checked").val(); 
		current = (current + 1) % problems.length;
		
		$("#caption").html("Задача № " + (current + 1));
		text.innerHTML = problems[current].getElementsByTagName("text")[0].childNodes[0].nodeValue;
		var distractorsData = problems[current].getElementsByTagName("distractor");
		var distractorsHTML = "";
		for (var j = 0; j < distractorsData.length; j++) {
			distractorsHTML += "<div class=\"distractor\">";
			distractorsHTML += "<input id=\"distractor" + j + "\" type=\"radio\"  name=\"distractors\" value=\"" + j + "\"";
			if (result !== "") {
				distractorsHTML += " disabled";
			}
			if (answers[current] == j) {
				distractorsHTML += " checked>";
			} else {
				distractorsHTML += ">";
			}
			distractorsHTML  += "<label for=\"distractor" + j + "\"";
			if (result !== "") {
				if ((correctAnswers[current] == answers[current]) && (answers[current] == j)) {
					distractorsHTML +=  "class=\"correct\"";
				} else if (answers[current] == j) {
					distractorsHTML += " class=\"incorrect\"";
				}
			}
			distractorsHTML += ">" + distractorsData[j].childNodes[0].nodeValue  + "</label>";
			distractorsHTML += "</div>";
		}
		$("#distractors").html(distractorsHTML);
	});
	
	$("#previous").click(function() {
		answers[current] = $("input[name='distractors']:checked").val();
		current = ((current - 1) + problems.length) % problems.length;		 
		
		$("#caption").html("Задача № " + (current + 1));
		text.innerHTML = problems[current].getElementsByTagName("text")[0].childNodes[0].nodeValue;
		var distractorsData = problems[current].getElementsByTagName("distractor");
		var distractorsHTML = "";
		for (var j = 0; j < distractorsData.length; j++) {
			distractorsHTML += "<div class=\"distractor\">";
			distractorsHTML += "<input id=\"distractor" + j + "\" type=\"radio\"  name=\"distractors\" value=\"" + j + "\"";
			if (result !== "") {
				distractorsHTML += " disabled";
			}
			if (answers[current] == j) {
				distractorsHTML += " checked>";
			} else {
				distractorsHTML += ">";
			}
			distractorsHTML  += "<label for=\"distractor" + j + "\"";
			if (result !== "") {
				if ((correctAnswers[current] == answers[current]) && (answers[current] == j)) {
					distractorsHTML +=  "class=\"correct\"";
				} else if (answers[current] == j) {
					distractorsHTML += " class=\"incorrect\"";
				}
			}
			distractorsHTML += ">" + distractorsData[j].childNodes[0].nodeValue  + "</label>";
			distractorsHTML += "</div>";
		}
		$("#distractors").html(distractorsHTML);
	});
	
	$("#check").click(function() {
		answers[current] = $("input[name='distractors']:checked").val();
		result = 0;
		for (var i = 0; i < problems.length; i++) {
			if (correctAnswers[i] == answers[i]) {
				result++;
			}
		}
		var data = result + "|" + answers.join();

		VK.init(function() {
			VK.api('storage.set', {key: 'math_kangaroo', value: data}, function() { });		
		});
	});
});

</script>
</head>
<body>
<header>
<h1>Кенгуру Тест</h1>
<nav>
<ul>
	<li><a href="https://vk.com/math_kangaroo">Кенгуру</a></li>
	<li><a href="./index.html">ЗНО Тренажер</a></li>
</ul>
</nav>
</header>
<section>
	<header>
		<h2 id="title"></h2>
		<a id="check">Перевірити</a>
	</header>
	<article>
		<div id="previous">
			<a href="javascript:void(null);">« попередня</a>
		</div>
		<h3 id="caption">Задача № 1</h3>
		<div id="next">
			<a href="javascript:void(null);">наступна »</a>
		</div>
		<div id="text">
		</div>
		<div id="distractors">
		</div>
	</article>
</section>
</body>
</html>